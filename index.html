<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üìè Od√≥metro GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (mapa tipo Google Maps, sin API key) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1120;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: #16a34a;
      --danger: #ef4444;
      --warn: #facc15;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
    }

    /* Splash / Barra de carga */
    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1f2937 0, #020617 60%);
      z-index: 20;
    }
    .splash-inner {
      text-align: center;
      padding: 24px 20px;
      border-radius: 24px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 20px 45px rgba(0,0,0,0.7);
      min-width: 260px;
      max-width: 320px;
    }
    .splash-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .splash-title span { font-size: 1.4rem; }
    .splash-sub {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .splash-bar-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .splash-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
    }
    .splash-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-soft));
      transition: width 0.15s ease-out;
    }
    .splash-percent {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      display: none;
    }

    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.2);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      padding: 18px 16px 20px;
      backdrop-filter: blur(12px);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    h1 {
      font-size: 1.2rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h1 span.emoji { font-size: 1.4rem; }
    .subtitle {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
      white-space: nowrap;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok { background: var(--accent); }
    .status-dot.warn { background: var(--warn); }

    /* Distancia principal en METROS */
    .main-distance {
      margin: 8px 0 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .distance-label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 2px;
    }
    .distance-m {
      font-size: 2.7rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    .distance-km {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .stat-card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      padding: 8px 8px 10px;
      border: 1px solid rgba(148,163,184,0.25);
      text-align: center;
    }
    .stat-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 0.95rem;
      font-weight: 600;
    }
    /* Velocidad grande */
    #speed {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .stat-sub {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 1px;
    }

    /* Debug precisi√≥n */
    .debug-row {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    /* Mapa */
    .map-wrap {
      margin-top: 10px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.3);
    }
    #map {
      width: 100%;
      height: 230px;
    }

    .controls {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .btn-row-main {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 10px;
      align-items: center;
    }
    .big-btn {
      border-radius: 999px;
      border: none;
      padding: 14px 16px;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
    }
    .big-btn:active {
      transform: scale(0.97);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5) inset;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #0f172a;
      box-shadow: 0 10px 25px rgba(34,197,94,0.5);
    }
    .btn-primary.paused {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #0b1120;
      box-shadow: 0 10px 25px rgba(234,88,12,0.5);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.95);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 10px 25px rgba(15,23,42,0.8);
      font-size: 0.9rem;
    }

    .btn-row-secondary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .btn-ghost {
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.7);
      color: var(--muted);
      font-size: 0.8rem;
      padding: 9px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease, transform 0.08s ease;
    }
    .btn-ghost:active { transform: scale(0.97); }
    .btn-ghost span.emoji { font-size: 1rem; }
    .btn-debug { width: 100%; margin-top: 4px; }

    /* Puntos de medici√≥n */
    .markers {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed rgba(148,163,184,0.4);
    }
    .markers-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }
    .markers-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .markers-title span.emoji { font-size: 1rem; }

    .marker-btn {
      border-radius: 999px;
      border: none;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      background: linear-gradient(135deg, #f97316, #fb923c);
      color: #0b1120;
      box-shadow: 0 10px 26px rgba(248,150,69,0.6);
    }
    .marker-btn:active {
      transform: scale(0.98);
      box-shadow: 0 6px 18px rgba(0,0,0,0.7) inset;
    }

    .markers-list {
      margin-top: 6px;
      max-height: 140px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.82rem;
    }
    .marker-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 4px;
    }
    .marker-line-1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .marker-name {
      font-weight: 600;
      font-size: 0.85rem;
    }
    .marker-segment {
      font-size: 0.85rem;
      color: var(--accent);
    }
    .marker-line-2 {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .marker-empty {
      font-size: 0.8rem;
      color: var(--muted);
      font-style: italic;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: center;
      opacity: 0.8;
    }
    .footer-note strong {
      color: var(--accent);
      font-weight: 500;
    }

    @media (max-width: 480px) {
      .card {
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-bottom: none;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      body { background: #020617; }
    }
  </style>
</head>
<body>
  <!-- Splash de carga -->
  <div class="splash" id="splash">
    <div class="splash-inner">
      <div class="splash-title">
        <span>üìè</span>
        Od√≥metro GPS
      </div>
      <div class="splash-sub">Cargando od√≥metro...</div>
      <div class="splash-bar-wrap">
        <div class="splash-bar">
          <div class="splash-bar-fill" id="splashFill"></div>
        </div>
        <div class="splash-percent" id="splashPercent">0%</div>
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <div class="card">
      <div class="header">
        <div class="title-wrap">
          <h1>
            <span class="emoji">üìè</span>
            Od√≥metro GPS
          </h1>
          <div class="subtitle">Med√≠ distancias en tiempo real con el celu</div>
        </div>
        <div class="status-pill" id="statusPill">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Sin iniciar</span>
        </div>
      </div>

      <!-- Distancia principal -->
      <div class="main-distance">
        <div class="distance-label">Distancia</div>
        <div class="distance-m" id="distanceMetersMain">0.0 m</div>
        <div class="distance-km" id="distanceKmSecondary">0.000 km</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Tiempo</div>
          <div class="stat-value" id="timeElapsed">00:00:00</div>
          <div class="stat-sub">Desde START</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Velocidad</div>
          <div class="stat-value" id="speed">0.0 km/h</div>
          <div class="stat-sub" id="speedSource">Estimando‚Ä¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ritmo</div>
          <div class="stat-value" id="pace">‚Äì:‚Äì min/km</div>
          <div class="stat-sub">Promedio</div>
        </div>
      </div>

      <!-- Debug precisi√≥n -->
      <div class="debug-row">
        <span>Precisi√≥n GPS: <strong id="gpsAccuracyText">‚Äì</strong></span>
        <span>√öltimo salto: <strong id="lastSegmentText">‚Äì</strong></span>
      </div>

      <!-- Mapa -->
      <div class="map-wrap">
        <div id="map"></div>
      </div>

      <div class="controls">
        <div class="btn-row-main">
          <button id="btnStartPause" class="big-btn btn-primary">
            ‚ñ∂Ô∏è START
          </button>
          <button id="btnReset" class="big-btn btn-secondary">
            üîÑ Reset
          </button>
        </div>

        <div class="btn-row-secondary">
          <button id="btnFullscreen" class="btn-ghost">
            <span class="emoji">üì±</span>
            Pantalla completa
          </button>
          <button id="btnLock" class="btn-ghost">
            <span class="emoji">üîí</span>
            Bloqueo t√°ctil
          </button>
        </div>

        <button id="btnSimulate" class="btn-ghost btn-debug">
          <span class="emoji">üß™</span>
          Test (simulaci√≥n sin GPS)
        </button>
      </div>

      <!-- Puntos de medici√≥n -->
      <div class="markers">
        <div class="markers-header">
          <div class="markers-title">
            <span class="emoji">üìç</span>
            Puntos de medici√≥n
          </div>
          <button id="btnAddMarker" class="marker-btn">
            ‚≠ï Marcar punto
          </button>
        </div>
        <div class="markers-list" id="markersList">
          <div class="marker-empty">
            Sin puntos todav√≠a. Toc√° <strong>‚ÄúMarcar punto‚Äù</strong> mientras te mov√©s.
          </div>
        </div>
      </div>

      <div class="footer-note">
        Para mayor precisi√≥n: usalo <strong>al aire libre</strong>, esper√° que el GPS est√© en verde y ponelo en <strong>PAUSE</strong> cuando te quedes quieto mucho rato.
      </div>
    </div>
  </div>

  <script>
    // -------------------
    // Estado de la app
    // -------------------
    let tracking = false;
    let watchId = null;
    let lastPosition = null;
    let totalDistanceM = 0;
    let startTime = null;
    let timerInterval = null;
    let touchLocked = false;

    // Puntos de medici√≥n
    let markers = [];
    let markerCounter = 0;

    // Debug
    let lastAccuracyM = null;
    let lastSegmentM = 0;

    // Mapa (Leaflet)
    let map = null;
    let pathLine = null;
    let lastLatLng = null;

    // Filtros de precisi√≥n (modo "od√≥metro serio")
    const GOOD_ACCURACY = 15;
    const OK_ACCURACY = 40;

    const distanceMetersMainEl = document.getElementById("distanceMetersMain");
    const distanceKmSecondaryEl = document.getElementById("distanceKmSecondary");
    const timeElapsedEl = document.getElementById("timeElapsed");
    const speedEl = document.getElementById("speed");
    const paceEl = document.getElementById("pace");
    const speedSourceEl = document.getElementById("speedSource");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const btnStartPause = document.getElementById("btnStartPause");
    const btnReset = document.getElementById("btnReset");
    const btnFullscreen = document.getElementById("btnFullscreen");
    const btnLock = document.getElementById("btnLock");
    const btnSimulate = document.getElementById("btnSimulate");
    const btnAddMarker = document.getElementById("btnAddMarker");
    const markersListEl = document.getElementById("markersList");
    const gpsAccuracyTextEl = document.getElementById("gpsAccuracyText");
    const lastSegmentTextEl = document.getElementById("lastSegmentText");

    const splash = document.getElementById("splash");
    const app = document.getElementById("app");
    const splashFill = document.getElementById("splashFill");
    const splashPercent = document.getElementById("splashPercent");

    // -------------------
    // Splash
    // -------------------
    function runSplash() {
      let progress = 0;
      const interval = setInterval(() => {
        const step = Math.floor(Math.random() * 7) + 3;
        progress += step;
        if (progress > 100) progress = 100;

        splashFill.style.width = progress + "%";
        splashPercent.textContent = progress + "%";

        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            splash.style.display = "none";
            app.style.display = "block";
          }, 300);
        }
      }, 120);
    }

    // -------------------
    // Utils
    // -------------------
    function setStatus(mode, text) {
      statusText.textContent = text;
      statusDot.classList.remove("ok", "warn");
      if (mode === "ok") statusDot.classList.add("ok");
      if (mode === "warn") statusDot.classList.add("warn");
    }

    function formatTime(totalSeconds) {
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = Math.floor(totalSeconds % 60);
      const pad = (v) => String(v).padStart(2, "0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // Haversine
    function distanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = (x) => x * Math.PI / 180;

      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateUI() {
      const km = totalDistanceM / 1000;
      distanceMetersMainEl.textContent = `${totalDistanceM.toFixed(1)} m`;
      distanceKmSecondaryEl.textContent = `${km.toFixed(3)} km`;

      if (startTime) {
        const elapsedSec = (Date.now() - startTime) / 1000;
        timeElapsedEl.textContent = formatTime(elapsedSec);

        if (km > 0.01) {
          const minutes = elapsedSec / 60;
          const pace = minutes / km;
          const paceMin = Math.floor(pace);
          const paceSec = Math.floor((pace - paceMin) * 60);
          const pad = (v) => String(v).padStart(2, "0");
          paceEl.textContent = `${pad(paceMin)}:${pad(paceSec)} min/km`;
        } else {
          paceEl.textContent = "‚Äì:‚Äì min/km";
        }
      } else {
        timeElapsedEl.textContent = "00:00:00";
        paceEl.textContent = "‚Äì:‚Äì min/km";
      }

      gpsAccuracyTextEl.textContent =
        lastAccuracyM != null ? `${lastAccuracyM.toFixed(0)} m` : "‚Äì";
      lastSegmentTextEl.textContent =
        lastSegmentM > 0 ? `${lastSegmentM.toFixed(1)} m` : "‚Äì";
    }

    function updateSpeedFromSegment(segmentDistM, deltaTimeSec) {
      if (!deltaTimeSec || deltaTimeSec <= 0 || !segmentDistM) return;
      const mPerSec = segmentDistM / deltaTimeSec;
      const kmh = mPerSec * 3.6;
      if (kmh >= 0 && kmh < 300) {
        speedEl.textContent = kmh.toFixed(1) + " km/h";
        speedSourceEl.textContent = "Por segmentos";
      }
    }

    // -------------------
    // Mapa
    // -------------------
    function updateMap(lat, lng) {
      const latlng = [lat, lng];

      if (!map) {
        map = L.map("map").setView(latlng, 17);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "¬© OpenStreetMap",
        }).addTo(map);

        pathLine = L.polyline([], {
          color: "#22c55e",
          weight: 4,
        }).addTo(map);

        L.circleMarker(latlng, {
          radius: 6,
          color: "#22c55e",
          fillColor: "#22c55e",
          fillOpacity: 0.9,
        }).addTo(map);
      }

      if (pathLine) {
        pathLine.addLatLng(latlng);
      }

      // Seguimiento suave
      map.setView(latlng);
      lastLatLng = latlng;
    }

    // -------------------
    // Puntos de medici√≥n
    // -------------------
    function renderMarkers() {
      if (!markers.length) {
        markersListEl.innerHTML = `
          <div class="marker-empty">
            Sin puntos todav√≠a. Toc√° <strong>‚ÄúMarcar punto‚Äù</strong> mientras te mov√©s.
          </div>
        `;
        return;
      }

      let html = "";
      markers.forEach((m) => {
        const totalKm = m.totalM / 1000;
        html += `
          <div class="marker-item">
            <div class="marker-line-1">
              <div class="marker-name">Punto ${m.id} ‚Ä¢ ${m.time}</div>
              <div class="marker-segment">+${m.segmentM.toFixed(1)} m</div>
            </div>
            <div class="marker-line-2">
              <span>Total: ${m.totalM.toFixed(1)} m</span>
              <span>${totalKm.toFixed(3)} km</span>
            </div>
          </div>
        `;
      });
      markersListEl.innerHTML = html;
    }

    function addMarker() {
      const totalM = totalDistanceM;
      const prevM = markers.length ? markers[markers.length - 1].totalM : 0;
      let segmentM = totalM - prevM;
      if (segmentM < 0) segmentM = 0;

      const now = new Date();
      const timeStr = now.toLocaleTimeString("es-AR", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });

      markerCounter++;
      markers.push({
        id: markerCounter,
        totalM,
        segmentM,
        time: timeStr,
      });

      renderMarkers();
    }

    // -------------------
    // L√≥gica GPS (modo precisi√≥n)
    // -------------------
    function handlePosition(pos) {
      const { latitude, longitude, accuracy, speed } = pos.coords;
      const now = Date.now();
      const gpsAccuracy = (typeof accuracy === "number") ? accuracy : 999;
      lastAccuracyM = gpsAccuracy;

      // Estado seg√∫n precisi√≥n
      if (gpsAccuracy <= GOOD_ACCURACY) {
        setStatus("ok", `GPS preciso (~${gpsAccuracy.toFixed(0)} m)`);
      } else if (gpsAccuracy <= OK_ACCURACY) {
        setStatus("warn", `GPS aceptable (~${gpsAccuracy.toFixed(0)} m)`);
      } else {
        setStatus("warn", `GPS inestable (> ${OK_ACCURACY} m)`);
      }

      if (!startTime) {
        startTime = now;
      }

      // Distancia + filtro
      if (lastPosition) {
        const dt = (now - lastPosition.timestamp) / 1000;
        const segment = distanceMeters(
          lastPosition.lat,
          lastPosition.lon,
          latitude,
          longitude
        );
        lastSegmentM = segment;

        let accept = false;

        if (gpsAccuracy <= GOOD_ACCURACY) {
          accept = segment >= 0.8 && segment <= 120 && dt > 0.7;
        } else if (gpsAccuracy <= OK_ACCURACY) {
          accept = segment >= 3 && segment <= 200 && dt > 0.7;
        } else {
          accept = false;
        }

        if (accept) {
          totalDistanceM += segment;
          updateSpeedFromSegment(segment, dt);
        }
      }

      // Velocidad directa del GPS (si viene)
      if (speed !== null && typeof speed === "number" && speed >= 0) {
        const kmh = speed * 3.6;
        if (kmh >= 0 && kmh < 300) {
          speedEl.textContent = kmh.toFixed(1) + " km/h";
          speedSourceEl.textContent = "Desde el GPS";
        }
      }

      lastPosition = {
        lat: latitude,
        lon: longitude,
        timestamp: now,
      };

      // Actualizar mapa
      updateMap(latitude, longitude);

      updateUI();
    }

    function handleError(err) {
      console.error("Error GPS:", err);
      if (err.code === 1) {
        setStatus("warn", "Permiso de ubicaci√≥n denegado");
      } else if (err.code === 2) {
        setStatus("warn", "No se pudo obtener la posici√≥n");
      } else if (err.code === 3) {
        setStatus("warn", "Timeout de GPS");
      } else {
        setStatus("warn", "Error de GPS");
      }
    }

    function startTracking() {
      if (tracking) return;
      if (!("geolocation" in navigator)) {
        alert("Tu navegador no soporta GPS. Prob√° con Chrome en el celu.");
        return;
      }

      tracking = true;
      btnStartPause.textContent = "‚è∏ PAUSE";
      btnStartPause.classList.add("paused");
      setStatus("ok", "Buscando se√±al‚Ä¶");

      if (!startTime) {
        startTime = Date.now();
      }

      watchId = navigator.geolocation.watchPosition(
        handlePosition,
        handleError,
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 15000,
        }
      );

      if (!timerInterval) {
        timerInterval = setInterval(() => {
          if (tracking && startTime) {
            updateUI();
          }
        }, 1000);
      }
    }

    function stopTracking() {
      if (!tracking) return;
      tracking = false;
      btnStartPause.textContent = "‚ñ∂Ô∏è START";
      btnStartPause.classList.remove("paused");
      setStatus("warn", "Pausado");

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    function resetAll() {
      stopTracking();
      totalDistanceM = 0;
      lastPosition = null;
      startTime = null;
      markers = [];
      markerCounter = 0;
      lastAccuracyM = null;
      lastSegmentM = 0;
      lastLatLng = null;

      // Reset mapa
      if (pathLine) {
        pathLine.setLatLngs([]);
      }

      updateUI();
      speedEl.textContent = "0.0 km/h";
      speedSourceEl.textContent = "Esperando movimiento‚Ä¶";
      setStatus("warn", "Reseteado");
      renderMarkers();
    }

    // -------------------
    // Simulaci√≥n (sin GPS)
    // -------------------
    function runDemoSimulation() {
      if (tracking || watchId !== null) {
        alert("Paus√° el od√≥metro antes de usar la simulaci√≥n.");
        return;
      }

      resetAll();
      setStatus("ok", "Simulaci√≥n de prueba");
      startTime = Date.now();
      lastAccuracyM = 5; // simulamos GPS muy preciso

      // Simulamos una l√≠nea en el mapa si existe
      if (!map) {
        // Centro arbitrario C√≥rdoba
        updateMap(-31.4167, -64.1833);
      }

      let steps = 0;
      const totalSteps = 20;
      const stepDist = 3;

      if (!timerInterval) {
        timerInterval = setInterval(() => {
          if (startTime) {
            updateUI();
          }
        }, 1000);
      }

      speedSourceEl.textContent = "Simulaci√≥n de prueba";

      const simInterval = setInterval(() => {
        steps++;
        totalDistanceM += stepDist;
        lastSegmentM = stepDist;
        updateSpeedFromSegment(stepDist, 0.5);
        updateUI();

        // Avanzamos un poco en el mapa tambi√©n
        if (lastLatLng && pathLine) {
          const [lat, lng] = lastLatLng;
          const newLat = lat + 0.00003;
          const newLng = lng + 0.00003;
          updateMap(newLat, newLng);
        }

        if (steps >= totalSteps) {
          clearInterval(simInterval);
          setStatus("warn", "Simulaci√≥n finalizada");
        }
      }, 500);
    }

    // -------------------
    // Pantalla completa
    // -------------------
    function toggleFullscreen() {
      const doc = document;
      const elem = document.documentElement;

      if (!doc.fullscreenElement &&
          !doc.webkitFullscreenElement &&
          !doc.mozFullScreenElement &&
          !doc.msFullscreenElement) {
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
      } else {
        if (doc.exitFullscreen) doc.exitFullscreen();
        else if (doc.webkitExitFullscreen) doc.webkitExitFullscreen();
        else if (doc.mozCancelFullScreen) doc.mozCancelFullScreen();
        else if (doc.msExitFullscreen) doc.msExitFullscreen();
      }
    }

    // -------------------
    // Bloqueo t√°ctil
    // -------------------
    function toggleTouchLock() {
      touchLocked = !touchLocked;
      if (touchLocked) {
        btnLock.innerHTML = '<span class="emoji">üß±</span> Desbloquear';
        setStatus("warn", "Toques bloqueados (solo START/PAUSE)");
      } else {
        btnLock.innerHTML = '<span class="emoji">üîí</span> Bloqueo t√°ctil';
        setStatus("ok", tracking ? "GPS activo" : "Listo");
      }
    }

    document.addEventListener("click", (e) => {
      if (!touchLocked) return;
      const target = e.target;
      if (
        target === btnStartPause ||
        target.closest("#btnStartPause") ||
        target === btnLock ||
        target.closest("#btnLock")
      ) {
        return;
      }
      e.stopPropagation();
      e.preventDefault();
    }, true);

    // -------------------
    // Eventos UI
    // -------------------
    btnStartPause.addEventListener("click", () => {
      if (tracking) stopTracking(); else startTracking();
    });
    btnReset.addEventListener("click", () => {
      if (confirm("¬øSeguro que quer√©s resetear todo el recorrido?")) resetAll();
    });
    btnFullscreen.addEventListener("click", toggleFullscreen);
    btnLock.addEventListener("click", toggleTouchLock);
    btnSimulate.addEventListener("click", runDemoSimulation);
    btnAddMarker.addEventListener("click", addMarker);

    // Estado inicial
    setStatus("warn", "Listo para iniciar");
    speedSourceEl.textContent = "Esperando movimiento‚Ä¶";
    updateUI();
    renderMarkers();

    document.addEventListener("DOMContentLoaded", runSplash);
  </script>
</body>
</html>