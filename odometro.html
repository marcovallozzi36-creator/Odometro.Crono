<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üìè Odometro GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1120;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: #16a34a;
      --danger: #ef4444;
      --warn: #facc15;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.2);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      padding: 18px 16px 20px;
      backdrop-filter: blur(12px);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      font-size: 1.2rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h1 span.emoji {
      font-size: 1.4rem;
    }

    .subtitle {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
    }

    .status-dot.ok {
      background: var(--accent);
    }

    .status-dot.warn {
      background: var(--warn);
    }

    .main-distance {
      margin: 10px 0 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .distance-value {
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .distance-unit {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-top: -4px;
    }

    .secondary-distance {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .stat-card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      padding: 8px 8px 10px;
      border: 1px solid rgba(148,163,184,0.25);
      text-align: center;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .stat-sub {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 1px;
    }

    .controls {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn-row-main {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .big-btn {
      border-radius: 999px;
      border: none;
      padding: 14px 16px;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
    }

    .big-btn:active {
      transform: scale(0.97);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5) inset;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #0f172a;
      box-shadow: 0 10px 25px rgba(34,197,94,0.5);
    }

    .btn-primary.paused {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #0b1120;
      box-shadow: 0 10px 25px rgba(234,88,12,0.5);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.95);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 10px 25px rgba(15,23,42,0.8);
      font-size: 0.9rem;
    }

    .btn-row-secondary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.7);
      color: var(--muted);
      font-size: 0.8rem;
      padding: 9px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease, transform 0.08s ease;
    }

    .btn-ghost:active {
      transform: scale(0.97);
    }

    .btn-ghost span.emoji {
      font-size: 1rem;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: center;
      opacity: 0.8;
    }

    .footer-note strong {
      color: var(--accent);
      font-weight: 500;
    }

    @media (max-width: 480px) {
      .card {
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-bottom: none;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      body {
        background: #020617;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="title-wrap">
          <h1>
            <span class="emoji">üìè</span>
            Odometro GPS
          </h1>
          <div class="subtitle">Med√≠ distancias en tiempo real con el celu</div>
        </div>
        <div class="status-pill" id="statusPill">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Sin iniciar</span>
        </div>
      </div>

      <div class="main-distance">
        <div class="distance-value" id="distanceKm">0.00</div>
        <div class="distance-unit">Kil√≥metros</div>
        <div class="secondary-distance" id="distanceMeters">(0 m)</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Tiempo</div>
          <div class="stat-value" id="timeElapsed">00:00:00</div>
          <div class="stat-sub">Desde que apretaste START</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Velocidad</div>
          <div class="stat-value" id="speed">0.0 km/h</div>
          <div class="stat-sub" id="speedSource">Estimando‚Ä¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ritmo</div>
          <div class="stat-value" id="pace">‚Äì:‚Äì min/km</div>
          <div class="stat-sub">Promedio</div>
        </div>
      </div>

      <div class="controls">
        <div class="btn-row-main">
          <button id="btnStartPause" class="big-btn btn-primary">
            ‚ñ∂Ô∏è START
          </button>
          <button id="btnReset" class="big-btn btn-secondary">
            üîÑ Reset
          </button>
        </div>

        <div class="btn-row-secondary">
          <button id="btnFullscreen" class="btn-ghost">
            <span class="emoji">üì±</span>
            Pantalla completa
          </button>
          <button id="btnLock" class="btn-ghost">
            <span class="emoji">üîí</span>
            Bloqueo t√°ctil
          </button>
        </div>
      </div>

      <div class="footer-note">
        Recomendado usar <strong>al aire libre</strong> y con <strong>GPS activado</strong> para mejor precisi√≥n.
      </div>
    </div>
  </div>

  <script>
    // -------------------
    // Estado de la app
    // -------------------
    let tracking = false;
    let watchId = null;
    let lastPosition = null;
    let totalDistanceM = 0;
    let startTime = null;
    let timerInterval = null;
    let touchLocked = false;

    const distanceKmEl = document.getElementById("distanceKm");
    const distanceMetersEl = document.getElementById("distanceMeters");
    const timeElapsedEl = document.getElementById("timeElapsed");
    const speedEl = document.getElementById("speed");
    const paceEl = document.getElementById("pace");
    const speedSourceEl = document.getElementById("speedSource");
    const statusPill = document.getElementById("statusPill");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const btnStartPause = document.getElementById("btnStartPause");
    const btnReset = document.getElementById("btnReset");
    const btnFullscreen = document.getElementById("btnFullscreen");
    const btnLock = document.getElementById("btnLock");

    // -------------------
    // Utils
    // -------------------

    function setStatus(mode, text) {
      statusText.textContent = text;
      statusDot.classList.remove("ok", "warn");
      if (mode === "ok") statusDot.classList.add("ok");
      if (mode === "warn") statusDot.classList.add("warn");
    }

    function formatTime(totalSeconds) {
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = Math.floor(totalSeconds % 60);
      const pad = (v) => String(v).padStart(2, "0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // Haversine: distancia en metros entre dos puntos lat/lon
    function distanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // radio Tierra en m
      const toRad = (x) => x * Math.PI / 180;

      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateUI() {
      const km = totalDistanceM / 1000;
      distanceKmEl.textContent = km.toFixed(2);
      distanceMetersEl.textContent = `(${totalDistanceM.toFixed(0)} m)`;

      if (startTime) {
        const elapsedSec = (Date.now() - startTime) / 1000;
        timeElapsedEl.textContent = formatTime(elapsedSec);

        if (km > 0.01) {
          const minutes = elapsedSec / 60;
          const pace = minutes / km; // min por km
          const paceMin = Math.floor(pace);
          const paceSec = Math.floor((pace - paceMin) * 60);
          const pad = (v) => String(v).padStart(2, "0");
          paceEl.textContent = `${pad(paceMin)}:${pad(paceSec)} min/km`;
        } else {
          paceEl.textContent = "‚Äì:‚Äì min/km";
        }
      } else {
        timeElapsedEl.textContent = "00:00:00";
        paceEl.textContent = "‚Äì:‚Äì min/km";
      }
    }

    function updateSpeedFromSegment(segmentDistM, deltaTimeSec) {
      if (!deltaTimeSec || deltaTimeSec <= 0 || !segmentDistM) return;
      const mPerSec = segmentDistM / deltaTimeSec;
      const kmh = mPerSec * 3.6;
      if (kmh >= 0 && kmh < 300) { // filtro anti-locuras
        speedEl.textContent = kmh.toFixed(1) + " km/h";
        speedSourceEl.textContent = "Por segmentos";
      }
    }

    // -------------------
    // L√≥gica GPS
    // -------------------

    function handlePosition(pos) {
      const { latitude, longitude, accuracy, speed } = pos.coords;
      const now = Date.now();

      if (accuracy > 40) {
        // se√±al medio chota, avisamos pero igual actualizamos tiempo
        setStatus("warn", `GPS inestable (${accuracy.toFixed(0)} m)`);
      } else {
        setStatus("ok", "GPS activo");
      }

      if (!startTime) {
        startTime = now;
      }

      // Distancia
      if (lastPosition) {
        const dt = (now - lastPosition.timestamp) / 1000;

        const segment = distanceMeters(
          lastPosition.lat,
          lastPosition.lon,
          latitude,
          longitude
        );

        // Filtro para saltos raros del GPS
        if (segment > 0 && segment < 200) {
          totalDistanceM += segment;
          updateSpeedFromSegment(segment, dt);
        }
      }

      // Si el dispositivo da speed directa (m/s), usamos eso
      if (speed !== null && typeof speed === "number" && speed >= 0) {
        const kmh = speed * 3.6;
        if (kmh >= 0 && kmh < 300) {
          speedEl.textContent = kmh.toFixed(1) + " km/h";
          speedSourceEl.textContent = "Desde el GPS";
        }
      }

      lastPosition = {
        lat: latitude,
        lon: longitude,
        timestamp: now,
      };

      updateUI();
    }

    function handleError(err) {
      console.error("Error GPS:", err);
      if (err.code === 1) {
        setStatus("warn", "Permiso de ubicaci√≥n denegado");
      } else if (err.code === 2) {
        setStatus("warn", "No se pudo obtener la posici√≥n");
      } else if (err.code === 3) {
        setStatus("warn", "Timeout de GPS");
      } else {
        setStatus("warn", "Error de GPS");
      }
    }

    function startTracking() {
      if (tracking) return;
      if (!("geolocation" in navigator)) {
        alert("Tu navegador no soporta GPS. Prob√° con Chrome en el celu.");
        return;
      }

      tracking = true;
      btnStartPause.textContent = "‚è∏ PAUSE";
      btnStartPause.classList.add("paused");
      setStatus("ok", "Buscando se√±al‚Ä¶");

      if (!startTime) {
        startTime = Date.now();
      }

      watchId = navigator.geolocation.watchPosition(
        handlePosition,
        handleError,
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 15000,
        }
      );

      if (!timerInterval) {
        timerInterval = setInterval(() => {
          if (tracking && startTime) {
            updateUI();
          }
        }, 1000);
      }
    }

    function stopTracking() {
      if (!tracking) return;
      tracking = false;
      btnStartPause.textContent = "‚ñ∂Ô∏è START";
      btnStartPause.classList.remove("paused");
      setStatus("warn", "Pausado");

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    function resetAll() {
      stopTracking();
      totalDistanceM = 0;
      lastPosition = null;
      startTime = null;
      updateUI();
      speedEl.textContent = "0.0 km/h";
      speedSourceEl.textContent = "Esperando movimiento‚Ä¶";
      setStatus("warn", "Reseteado");
    }

    // -------------------
    // Pantalla completa
    // -------------------

    function toggleFullscreen() {
      const doc = document;
      const elem = document.documentElement;

      if (!doc.fullscreenElement &&
          !doc.webkitFullscreenElement &&
          !doc.mozFullScreenElement &&
          !doc.msFullscreenElement) {
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
      } else {
        if (doc.exitFullscreen) doc.exitFullscreen();
        else if (doc.webkitExitFullscreen) doc.webkitExitFullscreen();
        else if (doc.mozCancelFullScreen) doc.mozCancelFullScreen();
        else if (doc.msExitFullscreen) doc.msExitFullscreen();
      }
    }

    // -------------------
    // Bloqueo t√°ctil "modo barra espaciadora"
    // -------------------

    function toggleTouchLock() {
      touchLocked = !touchLocked;
      if (touchLocked) {
        btnLock.innerHTML = '<span class="emoji">üß±</span> Desbloquear';
        setStatus("warn", "Toques bloqueados (solo START/PAUSE)");
      } else {
        btnLock.innerHTML = '<span class="emoji">üîí</span> Bloqueo t√°ctil';
        setStatus("ok", tracking ? "GPS activo" : "Listo");
      }
    }

    // Interceptor de clicks cuando est√° bloqueado
    document.addEventListener("click", (e) => {
      if (!touchLocked) return;
      const target = e.target;
      // Permitimos solo el bot√≥n START/PAUSE y el de Bloqueo
      if (
        target === btnStartPause ||
        target.closest("#btnStartPause") ||
        target === btnLock ||
        target.closest("#btnLock")
      ) {
        return;
      }
      e.stopPropagation();
      e.preventDefault();
    }, true);

    // -------------------
    // Eventos de UI
    // -------------------

    btnStartPause.addEventListener("click", () => {
      if (tracking) {
        stopTracking();
      } else {
        startTracking();
      }
    });

    btnReset.addEventListener("click", () => {
      if (confirm("¬øSeguro que quer√©s resetear todo el recorrido?")) {
        resetAll();
      }
    });

    btnFullscreen.addEventListener("click", () => {
      toggleFullscreen();
    });

    btnLock.addEventListener("click", () => {
      toggleTouchLock();
    });

    // Estado inicial
    setStatus("warn", "Listo para iniciar");
    speedSourceEl.textContent = "Esperando movimiento‚Ä¶";
    updateUI();
  </script>
</body>
</html>
